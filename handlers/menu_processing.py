from asyncio import gather
import time
import logging
from datetime import date

from sqlalchemy.ext.asyncio import AsyncSession
from database.orm_query import (
    orm_get_program,
    orm_get_programs,
    orm_get_training_day,
    orm_get_training_days,
    orm_get_exercises,
    orm_get_exercise,
    orm_get_banner,
    orm_get_user_by_id,
    orm_add_exercise,
    orm_get_admin_exercise,
    orm_get_categories,
    orm_get_admin_exercises_in_category,
    orm_get_category,
    orm_add_exercise_set,
    orm_get_exercise_sets,
    orm_turn_on_off_program,
    orm_get_user_exercises_in_category, orm_get_user_exercises, orm_get_user_exercise
)

from kbds.inline import (
    error_btns,
    get_user_programs_list,
    get_training_day_btns,
    get_profile_btns,
    get_schedule_btns,
    get_category_exercise_btns,
    get_category_btns,
    get_program_btns,
    get_trd_edit_btns,
    get_program_stgs_btns,
    get_edit_exercise_btns,
    get_exercise_settings_btns,
    get_training_process_btns,
    get_user_main_btns,
    get_custom_exercise_btns,
)
from utils.paginator import Paginator
from aiogram.types import InputMediaPhoto

from utils.separator import get_action_part

WEEK_DAYS_RU = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"]


def exercises_in_program(user_exercises: list):
    if user_exercises:
        caption_text = "<b>–í–∞—à–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:</b>\n\n" + "\n".join(
            [f"üîò <b>{ex.name}</b>" for ex in user_exercises])
    else:
        caption_text = "<strong>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ!</strong>"
    return caption_text


async def main_menu(session: AsyncSession):
    try:
        banner = await orm_get_banner(session, "main")
        banner_image = InputMediaPhoto(media=banner.image,
                                       caption=f"<strong>{banner.description}</strong>")
        kbds = get_user_main_btns()
        return banner_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ main_menu: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ main_menu"
        )
        kbds = error_btns()
        return error_image, kbds


async def profile(session: AsyncSession, level: int, action: str, user_id: int):
    try:
        banner, user = await gather(
            orm_get_banner(session, action),
            orm_get_user_by_id(session, user_id)
        )
        banner_image = InputMediaPhoto(media=banner.image,
                                       caption=f"<strong>{banner.description}:\n {user.name} ‚Äî –≤–µ—Å:"
                                               f" {user.weight}</strong>")
        kbds = get_profile_btns(level=level)
        return banner_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ profile: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ profile"
        )
        kbds = error_btns()
        return error_image, kbds


async def schedule(session: AsyncSession, level: int, action: str, training_day_id: int, user_id: int):
    try:
        banner, user_data = await gather(
            orm_get_banner(session, "schedule"),
            orm_get_user_by_id(session, user_id)
        )
        user_program = user_data.actual_program_id
        if user_program:
            today = date.today()
            trd_list = await orm_get_training_days(session, user_data.actual_program_id)
            day_of_week_to_id = {td.day_of_week.strip().lower(): td.id for td in trd_list}
            weekday_index = today.weekday()
            day_of_week_rus = WEEK_DAYS_RU[weekday_index].strip().lower()
            user_training_day_id = day_of_week_to_id.get(day_of_week_rus)
            if training_day_id is None:
                training_day_id = user_training_day_id
            user_trd = await orm_get_training_day(session, training_day_id)

            if user_trd is None:
                banner_image = InputMediaPhoto(
                    media=banner.image,
                    caption="–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–µ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω."
                )
                kbds = get_schedule_btns(
                    level=level,
                    year=today.year,
                    month=today.month,
                    action=action,
                    training_day_id=training_day_id,
                    first_exercise_id=None,
                    active_program=user_program,
                    day_of_week_to_id=day_of_week_to_id,
                )
                return banner_image, kbds

            user_exercises = await orm_get_exercises(session, training_day_id)
            if not user_exercises:
                exercises_caption = "–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è."
            else:
                exercises_caption = exercises_in_program(user_exercises)

            banner_image = InputMediaPhoto(
                media=banner.image,
                caption=f"{user_trd.day_of_week}\n\n{exercises_caption}"
            )

            first_exercise_id = user_exercises[0].id if user_exercises else None

            kbds = get_schedule_btns(
                level=level,
                year=today.year,
                month=today.month,
                action=action,
                training_day_id=training_day_id,
                first_exercise_id=first_exercise_id,
                active_program=user_program,
                day_of_week_to_id=day_of_week_to_id
            )

            return banner_image, kbds
        else:
            banner_image = InputMediaPhoto(
                media=banner.image,
                caption=f"{banner.description}\n\n–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n–°–æ–∑–¥–∞–π—Ç–µ –µ—ë –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!"
            )
            kbds = get_schedule_btns(
                level=level,
                year=None,
                month=None,
                action=action,
                training_day_id=None,
                first_exercise_id=None,
                active_program=None,
            )
            return banner_image, kbds

    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ schedule: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ schedule"
        )
        kbds = error_btns()
        return error_image, kbds


async def training_process(session: AsyncSession, level: int, training_day_id: int):
    try:
        banner = await orm_get_banner(session, "training_process")
        user_exercises = await orm_get_exercises(session, training_day_id)
        exercises_list = exercises_in_program(user_exercises)
        banner_image = InputMediaPhoto(media=banner.image, caption=banner.description + "\n\n" + exercises_list)
        kbds = get_training_process_btns(level=level, training_day_id=training_day_id)
        return banner_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ training_process: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ training_process"
        )
        kbds = error_btns()
        return error_image, kbds


async def programs_catalog(session: AsyncSession, level: int, action: str, user_id: int):
    try:
        banner, programs = await gather(
            orm_get_banner(session, action),
            orm_get_programs(session, user_id=user_id)
        )
        user_data = await orm_get_user_by_id(session, user_id)
        banner_image = InputMediaPhoto(media=banner.image, caption=banner.description)

        kbbs = get_user_programs_list(level=level, programs=programs, active_program_id=user_data.actual_program_id)
        return banner_image, kbbs
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ programs_catalog: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ programs_catalog"
        )
        kbds = error_btns()
        return error_image, kbds


def pages(paginator: Paginator, program_name: str):
    btns = {}
    if paginator.has_previous():
        btns["‚óÄ –ü—Ä–µ–¥."] = f"previous_{program_name}"
    if paginator.has_next():
        btns["–°–ª–µ–¥. ‚ñ∂"] = f"next_{program_name}"
    return btns


async def program(session: AsyncSession, level: int, training_program_id: int, user_id: int):
    try:
        user_program = await orm_get_program(session, training_program_id)
        banner = await orm_get_banner(session, "user_program")
        user_data = await orm_get_user_by_id(session, user_id)
        indicator = "üü¢" if user_data.actual_program_id == user_program.id else "üî¥"
        banner_image = InputMediaPhoto(media=banner.image,
                                       caption=f"<strong>{banner.description + user_program.name + ' ' + indicator}</strong>")
        kbds = get_program_btns(level=level, user_program_id=training_program_id)
        return banner_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ program: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ program"
        )
        kbds = error_btns()
        return error_image, kbds


async def program_settings(session: AsyncSession, level: int, training_program_id: int, action: str, user_id: int):
    try:
        user_program = await orm_get_program(session, training_program_id)
        user_data = await orm_get_user_by_id(session, user_id)
        active_program = True if user_data.actual_program_id else False

        # –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É
        if action == "turn_on_prgm":
            await orm_turn_on_off_program(session, user_id=user_id, program_id=training_program_id)
            active_program = True
        elif action == "turn_off_prgm":
            await orm_turn_on_off_program(session, user_id=user_id, program_id=None)
            active_program = False

        banner = await orm_get_banner(session, "user_program")
        indicator = "üü¢" if active_program else "üî¥"
        banner_image = InputMediaPhoto(
            media=banner.image,
            caption=f"<strong>{banner.description + user_program.name + ' ' + indicator}</strong>"
        )
        kbds = get_program_stgs_btns(level=level, user_program_id=training_program_id, action=action,
                                     active_program=active_program)
        return banner_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ program_settings: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ programs_settings"
        )
        kbds = error_btns()
        return error_image, kbds


async def training_days(session, level: int, training_program_id: int, page: int):
    try:
        user_program, training_days_list = await gather(
            orm_get_program(session, training_program_id),
            orm_get_training_days(session, training_program_id)
        )
        banner = await orm_get_banner(session, "user_program")

        paginator = Paginator(training_days_list, page=page)
        training_day = paginator.get_page()[0]
        user_exercises = await orm_get_exercises(session, training_day.id)
        caption_text = exercises_in_program(user_exercises)
        image = InputMediaPhoto(
            media=banner.image,
            caption=(
                f"<strong>{banner.description + user_program.name}\n\n"
                f" –î–µ–Ω—å {paginator.page} –∏–∑ {paginator.pages} ({training_day.day_of_week})\n\n"
                f"{caption_text}</strong>"
            )
        )
        pagination_btns = pages(paginator, user_program.name)

        kbds = get_training_day_btns(
            level=level,
            user_program_id=training_program_id,
            program=user_program,
            page=page,
            training_day_id=training_day.id,
            pagination_btns=pagination_btns
        )

        return image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ training_days: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ training_days"
        )
        kbds = error_btns()
        return error_image, kbds


async def edit_training_day(session: AsyncSession, level: int, training_program_id: int, page: int,
                            training_day_id: int, action: str):
    try:
        user_exercises = await orm_get_exercises(session, training_day_id)
        banner = await orm_get_banner(session, "user_program")
        training_day = await orm_get_training_day(session, training_day_id)
        caption_text = exercises_in_program(user_exercises)
        empty_list = not user_exercises

        user_image = InputMediaPhoto(
            media=banner.image,
            caption=f"<strong>{training_day.day_of_week}\n\n{caption_text}</strong>",
        )

        kbds = get_trd_edit_btns(level=level, program_id=training_program_id, page=page,
                                 training_day_id=training_day_id,
                                 empty_list=empty_list, action=action)

        return user_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ edit_training_day: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ edit_training_day"
        )
        kbds = error_btns()
        return error_image, kbds


async def show_categories(session: AsyncSession, level: int, training_program_id: int, training_day_id: int, page: int,
                          action: str, user_id: int):
    try:
        user_exercises = await orm_get_exercises(session, training_day_id)
        user_data = await orm_get_user_by_id(session, user_id)
        user_name = user_data.name
        user_custom_exercises = await orm_get_user_exercises(session, user_id)
        categories = await orm_get_categories(session, user_id)

        user_program = await orm_get_program(session, training_program_id)
        banner = await orm_get_banner(session, "user_program")
        caption_text = exercises_in_program(user_exercises)

        user_image = InputMediaPhoto(
            media=banner.image,
            caption=f"<strong>{banner.description + user_program.name}\n\n{caption_text}\n\n"
                    f"–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</strong>",
        )

        kbds = get_category_btns(
            level=level,
            program_id=training_program_id,
            training_day_id=training_day_id,
            page=page,
            categories=categories,
            action=action,
            user_name=user_name,
            len_custom=len(user_custom_exercises),
        )

        return user_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ show_categories: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ show_categories"
        )
        kbds = error_btns()
        return error_image, kbds


async def show_exercises_in_category(session: AsyncSession, level: int, exercise_id: int, training_day_id: int,
                                     page: int, action: str, training_program_id: int, category_id: int, user_id: int,
                                     empty: bool):
    try:
        banner = await orm_get_banner(session, "user_program")
        category = await orm_get_category(session, category_id)
        user_program = await orm_get_program(session, training_program_id)
        admin_exercises = await orm_get_admin_exercises_in_category(session, category_id)
        user_exercises = await orm_get_exercises(session, training_day_id)
        user_custom_exercises = await orm_get_user_exercises_in_category(session, category_id, user_id)

        # –ï—Å–ª–∏ action –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ "add_..." - –¥–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤ —Å–ø–∏—Å–æ–∫
        if get_action_part(action).startswith("add_"):
            if exercise_id:
                if "custom" in get_action_part(action):
                    exercise = await orm_get_user_exercise(session, exercise_id)
                    exercise_type = 'user'
                else:
                    exercise = await orm_get_admin_exercise(session, exercise_id)
                    exercise_type = 'admin'

                if exercise:
                    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                    add_data = {
                        "name": exercise.name,
                        "description": exercise.description,
                    }

                    if exercise_type == 'admin':
                        add_data['admin_exercise_id'] = exercise.id
                    elif exercise_type == 'user':
                        add_data['user_exercise_id'] = exercise.id

                    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞
                    await orm_add_exercise(session, add_data, training_day_id, exercise_type)
                    user_exercises = await orm_get_exercises(session, training_day_id)

                    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                    for _ in range(user_exercises[-1].base_sets):
                        await orm_add_exercise_set(session, user_exercises[-1].id, user_exercises[-1].base_reps)

        if not empty and category_id:
            caption_text = exercises_in_program(user_exercises)

            user_image = InputMediaPhoto(
                media=banner.image,
                caption=f"<strong>{banner.description + user_program.name}\n\n{caption_text}\n\n"
                        f"–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {category.name}</strong>",
            )
            kbds = get_category_exercise_btns(level=level,
                                              program_id=training_program_id,
                                              training_day_id=training_day_id,
                                              page=page,
                                              template_exercises=admin_exercises,
                                              user_exercises=user_custom_exercises, actual_exercises=user_exercises,
                                              action=action, category_id=category_id, empty=empty)

        else:
            user_custom_exercises = await orm_get_user_exercises(session, user_id)
            caption_text = exercises_in_program(user_exercises)
            if user_custom_exercises:
                user_image = InputMediaPhoto(
                    media=banner.image,
                    caption=f"<strong>{banner.description + user_program.name}\n\n{caption_text}\n\n"
                            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:</strong>",
                )
            else:
                user_image = InputMediaPhoto(
                    media=banner.image,
                    caption=f"<strong>{banner.description + user_program.name}\n\n{caption_text}\n\n"
                            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:\n\n"
                            f"{exercises_in_program(user_custom_exercises)}</strong>",
                )
            kbds = get_category_exercise_btns(level=level,
                                              program_id=training_program_id,
                                              training_day_id=training_day_id,
                                              page=page,
                                              user_exercises=user_custom_exercises,
                                              category_id=None,
                                              action=action, empty=empty, actual_exercises=user_exercises)

        return user_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ show_exercises_in_category: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ show_exercises_in_category"
        )
        kbds = error_btns()
        return error_image, kbds


async def edit_exercises(session: AsyncSession, level: int, exercise_id: int, training_day_id: int,
                         page: int, action: str, training_program_id: int):
    try:
        user_exercises = await orm_get_exercises(session, training_day_id)
        banner = await orm_get_banner(session, "user_program")
        user_image = InputMediaPhoto(
            media=banner.image,
            caption="<strong>–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞:</strong>",
        )

        kbds = get_edit_exercise_btns(level=level, program_id=training_program_id, user_exercises=user_exercises,
                                      page=page, exercise_id=exercise_id,
                                      action=action,
                                      training_day_id=training_day_id)

        return user_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ edit_exercises: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ edit_exercises"
        )
        kbds = error_btns()
        return error_image, kbds


async def exercise_settings(session: AsyncSession, level: int, exercise_id: int, training_day_id: int,
                            page: int, action: str, training_program_id: int):
    try:
        user_exercise = await orm_get_exercise(session, exercise_id)
        banner = await orm_get_banner(session, "user_program")
        base_ex_sets = await orm_get_exercise_sets(session, exercise_id)
        user_image = InputMediaPhoto(
            media=banner.image,
            caption="<strong>–î–æ–±–∞–≤—å—Ç–µ –Ω—É–∂–Ω–æ–µ –≤–∞–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</strong>",
        )

        kbds = get_exercise_settings_btns(level=level, action=action, program_id=training_program_id,
                                          page=page, exercise_id=exercise_id,
                                          training_day_id=training_day_id, user_exercise=user_exercise,
                                          base_ex_sets=base_ex_sets)

        return user_image, kbds
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ exercise_settings: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ exercise_settings"
        )
        kbds = error_btns()
        return error_image, kbds


async def custom_exercises(session: AsyncSession, level: int, training_day_id: int,
                           page: int, action: str, training_program_id: int, category_id: int, user_id: int,
                           empty: bool, exericse_id: int):
    try:
        if empty is False and category_id:
            custom_user_exercises = await orm_get_user_exercises_in_category(session, category_id, user_id)
            user_category = await orm_get_category(session, category_id)
            banner = await orm_get_banner(session, "user_program")
            if custom_user_exercises:

                user_image = InputMediaPhoto(
                    media=banner.image,
                    caption=f"<strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ({user_category.name})</strong>\n\n"
                            f"<strong>–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞:</strong>"
                )
            else:
                user_image = InputMediaPhoto(
                    media=banner.image,
                    caption=f"<strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ({user_category.name})</strong>\n\n"
                            f"<strong>{exercises_in_program(custom_user_exercises)}</strong>"
                )

            kbds = get_custom_exercise_btns(level=level, action=action, program_id=training_program_id, page=page,
                                            training_day_id=training_day_id, category_id=category_id, empty=empty,
                                            user_exercises=custom_user_exercises, exercise_id=exericse_id)
        else:
            custom_user_exercises = await orm_get_user_exercises(session, user_id)
            banner = await orm_get_banner(session, "user_program")
            if custom_user_exercises:

                user_image = InputMediaPhoto(
                    media=banner.image,
                    caption=f"<strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: </strong>\n\n"
                            f"<strong>–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞:</strong>")
            else:
                user_image = InputMediaPhoto(
                    media=banner.image,
                    caption=f"<strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: </strong>\n\n"
                            f"<strong>{exercises_in_program(custom_user_exercises)}</strong>")

            kbds = get_custom_exercise_btns(level=level, action=action, program_id=training_program_id, page=page,
                                            training_day_id=training_day_id, category_id=category_id, empty=empty,
                                            user_exercises=custom_user_exercises, exercise_id=exericse_id)

        return user_image, kbds

    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ custom_exercises: {e}")
        error_image = InputMediaPhoto(
            media='https://postimg.cc/Ty7d15kq',
            caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ custom_exercises"
        )
        kbds = error_btns()
        return error_image, kbds


async def get_menu_content(session: AsyncSession, level: int, action: str, training_program_id: int = None,
                           exercise_id: int = None, page: int = None, training_day_id: int = None, user_id: int = None,
                           category_id: int = None, month: int = None, year: int = None, set_id: int = None,
                           empty: bool = False):
    start_time = time.monotonic()
    try:
        # –í —ç—Ç–æ–º –∫–æ–¥–µ –º—ã –∏—Å—Ö–æ–¥–∏–º –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ action —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ menu_name.
        if level == 0:
            # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
            return await main_menu(session)

        elif level == 1:
            if action == "program":
                return await programs_catalog(session, level, action, user_id)
            elif action == "profile":
                return await profile(session, level, action, user_id)
            elif action in ["schedule", "month_schedule", "t_day"]:
                return await schedule(session, level, action, training_day_id, user_id)

        elif level == 2:
            # –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            if action == "training_process":
                return await training_process(session, level, training_day_id)
            return await program(session, level, training_program_id, user_id)

        elif level == 3:
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–ª–∏ –¥–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            if action in ["prg_stg", "turn_on_prgm", "turn_off_prgm"] or action.startswith(
                    "to_del_prgm") or action.startswith("prgm_del"):
                return await program_settings(session, level, training_program_id, action, user_id)
            return await training_days(session, level, training_program_id, page)

        elif level == 4:
            # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–≥–æ –¥–Ω—è
            return await edit_training_day(session, level, training_program_id, page, training_day_id, action)

        elif level == 5:
            # –õ–∏–±–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π, –ª–∏–±–æ –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if action in ["edit_excs", "shd/edit_excs", "to_edit", "shd/to_edit",
                          "del", "shd/del", "mv", "shd/mv"]:
                return await edit_exercises(session, level, exercise_id, training_day_id, page, action,
                                            training_program_id)
            else:
                return await show_categories(session, level, training_program_id, training_day_id, page, action,
                                             user_id)

        elif level == 6:
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if action in ["ex_stg", "shd/ex_stg"] or action.startswith("‚ûï") or action.startswith(
                    "‚ûñ") or action.startswith("shd/‚ûï") or action.startswith("shd/‚ûñ"):
                return await exercise_settings(session, level, exercise_id, training_day_id, page, action,
                                               training_program_id)
            return await show_exercises_in_category(session, level, exercise_id, training_day_id, page, action,
                                                    training_program_id, category_id, user_id, empty)

        elif level == 7:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            return await custom_exercises(session, level, training_day_id, page, action,
                                          training_program_id, category_id, user_id, empty, exercise_id)

        else:
            logging.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –º–µ–Ω—é: {level}")
            return (InputMediaPhoto(media='https://postimg.cc/Ty7d15kq',
                                    caption="–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –º–µ–Ω—é"),
                    error_btns())
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –≤ get_menu_content: {e}")
        return (InputMediaPhoto(media='https://postimg.cc/Ty7d15kq',
                                caption="–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é"),
                error_btns())
    finally:
        end_time = time.monotonic()
        duration = end_time - start_time
        logging.info(f"get_menu_content –¥–ª—è action='{action}', level={level} –∑–∞–Ω—è–ª–∞ {duration:.2f} —Å–µ–∫—É–Ω–¥")
